<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Viewer</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/bootstrap-theme.min.css">

    <script src="js/math.min.js" type="text/javascript"></script>
    <script src="js/jquery-1.11.1.min.js" type="text/javascript"></script>
    <script src="js/msgpack.min.js"></script>
    <script src="js/bootstrap.min.js"></script>

    <script src="js/imagewarp/deformation.js"></script>
    <script src="js/imagewarp/interpolation.js"></script>
    <script src="js/imagewarp/point.js"></script>
    <script src="js/imagewarp/matrix22.js"></script>

    <script src="js/3dview/three.min.js"></script>
    <script src="js/3dview/OrbitControls.js"></script>
    <script src="js/3dview/3dview.js"></script>
</head>
<script>
    var modelview = math.matrix([[0.9751816987991333, 0.054630883038043976, 0.2145603597164154, 173.72955322265625], [0.019009031355381012, 0.9448434114456177, -0.3269703984260559, 351.22564697265625], [-0.22058862447738647, 0.3229341506958008, 0.920355498790741, 0.0], [0.0, 0.0, 0.0, 1.0]]);
var projection = math.matrix([[0.005775849334895611, 0.0, 0.0, -1.0], [0.0, 0.00433099502697587, 0.0, -1.0], [0.0, 0.0, -1.0, 0.0], [0.0, 0.0, 0.0, 1.0]]);
var viewport = [0, 1619, 1214, -1619];
var indexs = [2821, 2800, 2808, 2769, 2770, 2605, 2606, 2811, 2825, 2862, 4133, 4130, 4126, 4121, 4106, 4040, 4020, 4003, 3982, 3958, 3923, 3896, 3864, 3832, 3816, 3795, 3796, 3749, 3737, 3723, 3686, 3636, 3606, 3593, 3556, 3528, 3502, 3485, 3472, 3446, 3443, 3436, 3432, 3424, 3423, 3412, 3411, 3407, 3406, 3402, 2675, 2699, 2686, 2674, 2667, 2659, 2901, 2904, 2910, 2922, 2936, 2966, 3011, 3285, 3332, 3379, 3383, 3384, 2859, 2848, 2860, 495, 1337, 2193, 1309, 2915, 2990, 3071, 3243, 3318, 3361, 114, 669, 1945, 2483, 1285, 765, 1334];

//    var face_features = [-0.5532902693274548, -0.8292028651409497, 1.0571687459841956, -2.3025305505203026, 0.7430163410793367, -0.11145151560924439, 1.7776416134608717, 1.460948256842372, 1.7136922760503297, -2.6220371383058376, -2.941108959078685, -2.1813370277754833];
    var face_features = [-1.3899188, -0.31437248, 0.39862245, -0.17326295, -0.58920825, 1.33979106, 0.24576366, -0.23009896, -0.9392814, -1.3747803, -2.34062982, 0.73216659, -1.65795839, -1.09947038, -1.68242455, 1.26441729, 0.52666277, -1.08615279, -1.37764704, -0.10091068, -1.22396874, -0.14061791, -0.11206818, -0.74355024, 2.15908194, -1.05449438, -0.74450868, -1.38947666, -0.38417625, -1.98786008, -0.20028761, 0.94499606, -2.0136745, 2.18466759, -0.26373667, -0.56074834, -0.07350224, -0.32011729, 0.23012736, -0.70777565, 1.06910682, -1.30811071, -1.37783968, 0.52656472, -0.11109983, -0.11986182, -0.2666713, 0.33289737, -0.95165789, -0.58249366, -0.79010588, 0.13853192, 1.26283312, -0.0642623, 0.95973945, 0.78225952, 0.03489829, 0.39579889, -0.17772783, 0.4263019, -1.29014635, -1.53219414, 0.21380037, 0.25274134, -0.2175387, -0.95807874, -0.67026711, -0.86947596, 0.23103558, 1.09530187, 0.79784453, -0.77484584, 0.16089122, -0.39230999, -0.03486511, -0.62317973, -0.4159916, 0.19297919, 0.9896853, 0.91287416, -0.54414606, 0.78180784, 0.18172094, 0.0965414, -0.29660341, -0.54517114, 0.04756223, 0.04124359, 0.6284008, 0.45518121, 0.72639918, 0.40954083, 1.05767655, -0.59409547, 0.84799439, 0.84707612, -0.21827903, 0.36823744, -0.27945986];
    var age_features = math.matrix([0.01735531911253929, -0.034197837114334106, 0.00775162735953927, -0.011590328998863697, 0.0005499027320183814, -0.011274131014943123, 0.010518035851418972, 0.025152623653411865, -0.01392435934394598, -0.01796623133122921, -0.025758760049939156, -0.017126472666859627, 0.017489992082118988, -0.004911258351057768, 0.023187244310975075, -0.018283093348145485, 0.007094316650182009, 0.0018614016007632017, -0.0015065653715282679, 0.012836641632020473, 0.012816769070923328, 0.014318742789328098, -0.019734768196940422, 0.014487558044493198, -0.02771804668009281, -0.018184680491685867, -0.009945341385900974, 0.01053866557776928, 0.008464627899229527, 0.007258077152073383, -0.00040599991916678846, -0.008162363432347775, -0.002797245979309082, 0.01381059642881155, 0.011791604571044445, -0.02187740057706833, -0.01549582090228796, -0.014062859117984772, 0.007278412114828825, 0.008372697979211807, -0.013030478730797768, 0.0008058835519477725, 0.008555153384804726, -0.005448527168482542, 0.0031326347962021828, -0.012375571765005589, -0.018323808908462524, 0.0066565279848873615, 2.312334254384041e-05, -0.008924834430217743, -0.01502560917288065, 0.014599103480577469, -0.00525270402431488, -0.00314724980853498, -0.0023898249492049217, 0.009374379180371761, -0.013422139920294285, 0.002607425907626748, 0.007019920740276575, 0.0060414401814341545, 0.002056940458714962, -0.01185487862676382, 0.0014679217711091042, 0.0021107865031808615, 0.010274372063577175, -0.0027191536501049995, -0.0065644653514027596, -0.00693257013335824, 0.0044031389988958836, -0.0029326756484806538, 0.0008102384745143354, -0.004243033938109875, -0.000740793882869184, 0.0030895359814167023, 0.007354707922786474, 0.004219961352646351, -0.0013479444896802306, -0.005169478245079517, 0.0005390347214415669, -0.004733705893158913, 0.001055526896379888, -0.007054801564663649, -0.002379177138209343, -0.007069769315421581, -0.00680055096745491, -0.011156775988638401, -0.005911494605243206, -0.003553977934643626, 0.0018074921099469066, -0.008513268083333969, 0.003107501193881035, -0.0033137935679405928, -0.0074830553494393826, -0.007562566548585892, -0.006403525359928608, 0.0001641842391109094, 0.008576116524636745, -0.0009218196501024067, 0.007856249809265137]);
    var gender_features = math.matrix([0.3883183002471924, 0.14995604753494263, -0.3460806906223297, -0.10603531450033188, -0.12025775760412216, 0.3650549054145813, 0.006873925216495991, -0.18150588870048523, 0.05957718566060066, -0.18344905972480774, -0.08872059732675552, -0.18571248650550842, 0.16947464644908905, -0.12282343208789825, 0.021033767610788345, -0.013913368806242943, 0.02030877023935318, 0.02551252208650112, 0.11601345241069794, -0.1429605782032013, 0.06179741770029068, 0.08572539687156677, 0.02643299102783203, -0.00522705540060997, -0.0013855419820174575, -0.14895541965961456, -0.046120282262563705, -0.08545422554016113, -0.22276873886585236, -0.07582779973745346, -0.10518898814916611, -0.05726182833313942, 0.029240906238555908, -0.09042397886514664, -0.04744865000247955, -0.19660231471061707, -0.08968722820281982, 0.03618956729769707, 0.04953981935977936, 0.15555863082408905, -0.007982009090483189, -0.12521210312843323, 0.04197800159454346, 0.050437070429325104, -0.010352123528718948, 0.033436886966228485, 0.012643334455788136, 0.11748013645410538, -0.040278248488903046, 0.03259924054145813, -0.3028106093406677, -0.04453546553850174, 0.18166887760162354, -0.03401477262377739, 0.13515424728393555, -0.14396178722381592, 0.011354997754096985, 0.023235851898789406, -0.007202880922704935, 0.00416773883625865, 0.08303716778755188, -0.05498439818620682, -0.06770392507314682, 0.14354701340198517, 0.07019209116697311, 0.051022663712501526, -0.03421781212091446, -0.018308579921722412, 0.07342279702425003, -0.08982858806848526, 0.1301702857017517, 0.06310748308897018, -0.011345837265253067, -0.0019437192240729928, -0.09440243244171143, 0.05377109348773956, -0.05625089257955551, -0.05748775601387024, 0.02608371526002884, 0.04286834970116615, -0.09126929938793182, -0.005909076426178217, -0.028781823813915253, -0.05894480273127556, -0.0946434885263443, -0.08503683656454086, 0.04009361192584038, -0.04559808224439621, -0.004911585710942745, -0.027993706986308098, 0.024146707728505135, -0.10711164027452469, -0.001730237971059978, 0.06647336483001709, 0.047006264328956604, 0.04592158645391464, -0.05218423902988434, -0.03547785058617592, -0.10992905497550964]);
    var weight_features = math.matrix([0.04435132443904877, 0.0013906864915043116, -0.0020525201689451933, 0.02025793306529522, -0.002918500453233719, -0.0227334126830101, 0.0067942203022539616, -0.0007726033800281584, 0.005446926224976778, 0.019335037097334862, 0.01703542098402977, 0.015140709467232227, -0.013595500029623508, 0.00484832189977169, 0.0007463566143997014, -0.0021606574300676584, -0.008652226068079472, -0.0025784168392419815, 0.004533584229648113, 0.0012447454500943422, -0.018607858568429947, 0.005388220306485891, 0.007890406996011734, 0.005869496613740921, 0.004499227739870548, 0.012867433950304985, 0.005786828696727753, 0.0060062287375330925, 0.013482351787388325, 0.004734185058623552, 0.011995806358754635, 0.010440756566822529, 0.007785365451127291, 0.0022859033197164536, 0.00429563457146287, 0.009380408562719822, 0.009313889779150486, 0.002546503208577633, -0.0008225789060816169, 0.002254567574709654, 0.00986535008996725, 0.00824431050568819, -0.006692088209092617, -0.006950055249035358, -0.0013658794341608882, -0.0027028145268559456, 0.004121068865060806, 0.0001581047399668023, 0.0019448640523478389, -0.004060030914843082, 0.01069682091474533, -0.00685839680954814, -0.010674438439309597, -0.005477572791278362, -0.006379339843988419, 0.006960771046578884, 0.0009438000270165503, 0.0014057978987693787, -0.005241249222308397, 0.0026599231641739607, 0.00013752574159298092, 0.008627519011497498, 0.007289668079465628, -0.0012705278350040317, -0.011211371049284935, 0.004887033719569445, -0.009924106299877167, -0.005602528806775808, -0.00027207512175664306, 0.004648516420274973, -0.003960740752518177, 0.0005875329370610416, 0.0019237804226577282, -8.084078581305221e-05, 0.004617598373442888, 0.00216966075822711, 0.011509777046740055, 0.0031984029337763786, 0.009314566850662231, -0.00953530240803957, -0.0029324949719011784, -0.0005804644315503538, 0.0010014191502705216, -0.003947560675442219, 0.005685706157237291, 0.011672102846205235, -0.0023486546706408262, -0.002222574781626463, -0.004537609405815601, 0.005568463355302811, -0.000761622388381511, 0.002365095540881157, 0.004186393227428198, -0.003404908813536167, -0.00657084584236145, 0.008538826368749142, -0.003935535438358784, -0.005404730327427387, 0.0011788051342591643]);
    var height_features = math.matrix([0.01226912159472704, -0.014971583150327206, 0.023426830768585205, -0.030797621235251427, 0.015781255438923836, 0.014636924490332603, -0.005356378387659788, 0.0005626830388791859, -0.005842097569257021, -0.014401556923985481, -0.0003765946312341839, 0.004628890659660101, -0.0013333711540326476, 0.008188417181372643, 0.005642968229949474, 0.004992200527340174, 0.004312222357839346, 0.0032662563025951385, -0.009873270988464355, 0.003735311096534133, 0.010524344630539417, -0.014440546743571758, -0.01381372194737196, -0.003665429074317217, 0.00902541819959879, -0.007860013283789158, 0.0065715801902115345, -0.004018637351691723, 0.006458478048443794, 0.0007336873677559197, -0.009387290105223656, 0.00516524538397789, -0.01484704203903675, 0.008009261451661587, -0.0023533354979008436, 0.01416412927210331, -0.005223889369517565, -0.00801470410078764, -0.004234423395246267, -0.01834537647664547, -0.012682654894888401, -0.0017831280129030347, 0.00979082565754652, 0.005555004347115755, 0.0043595340102910995, -0.0011459693778306246, -0.005997532047331333, -0.00960992556065321, 0.0003247645800001919, 0.0017426555277779698, 0.028303971514105797, 0.019415875896811485, 0.0017502770060673356, 0.016639797016978264, -0.00099393748678267, 0.006790762301534414, -0.0041913618333637714, -0.00727441580966115, 0.01008396502584219, -0.0007589915185235441, -0.017030201852321625, -0.0036807991564273834, -0.0014254848938435316, -0.018292458727955818, -0.0030549203511327505, -0.014197085984051228, 0.025719914585351944, 0.006496230140328407, -0.009356440976262093, 0.00747926440089941, -0.011539260856807232, -0.007574968971312046, 0.0024956853594630957, -0.003817431628704071, 0.008073117583990097, -0.01082227285951376, -0.006596348714083433, 0.006166649516671896, -0.014641833491623402, 0.004866395611315966, 0.010665991343557835, 0.0026488881558179855, 0.006183114368468523, 0.009142221882939339, 0.009320687502622604, -0.0034054194111377, -0.0025345301255583763, 0.00811680220067501, 0.004839800763875246, -0.007973852567374706, -0.004562717396765947, 0.009491740725934505, -0.008869791403412819, -0.0017957178642973304, 0.0053195711225271225, -0.01586143858730793, 0.013128278777003288, 0.01835833489894867, 0.0073761180974543095]);

//    var indexs = [11, 2578, 2579, 2580, 21, 2581, 2072, 2076, 2589, 2082, 2083, 2086, 2091, 2101, 590, 605, 606, 607, 2657, 2658, 610, 100, 614, 2160, 2161, 624, 114, 658, 662, 666, 2203, 2204, 157, 172, 173, 174, 177, 693, 181, 2235, 2237, 191, 2247, 1736, 1738, 2262, 2263, 2264, 2265, 1755, 1757, 736, 225, 229, 1766, 1767, 233, 2794, 2797, 756, 2816, 770, 775, 264, 270, 272, 2842, 1819, 1820, 797, 1822, 1823, 800, 1833, 812, 825, 1850, 1851, 315, 1861, 2373, 2374, 1863, 329, 841, 2394, 2395, 2396, 1895, 363, 365, 1908, 1909, 373, 379, 382, 392, 393, 398, 411, 413, 431, 2508, 2001, 2011, 2012, 2533, 2026];

    var canvas, ctx;
    var origverts, origpoints;
    var model;
    var imgWarper;
    var img = new Image();

    var showLandmarks = false;

    img.onload = function(){
        console.log("img downloaded");
        initializeImgWarper();
    };
    img.src="img/5i7r2x0.jpg";

    //init function
    $(function() {
        //begin downloading the model
        downloadMsgPack('bfm_small.msg', modelReady);

        //intialize the 3d rendering code
        init3d();
        animate();

        //get the canvas object
        canvas = document.getElementById("warpCanvas");
        origImage = document.getElementById("origImage");
        ctx = canvas.getContext("2d");

        $("#showlandmarks").change(function() {
            showLandmarks = !showLandmarks;
            updatemesh();
        });
        $("#showgrid").change(function() {
            imgWarper.toggleGrid();
            updatemesh();
        });

        resetCoeffs();
        $("#coeffGender").change(function() {
            updatemesh();
        });
        $("#coeffAge").change(function() {
            updatemesh();
        });
        $("#coeffWeight").change(function() {
            updatemesh();
        });
        $("#coeffHeight").change(function() {
            updatemesh();
        });
        $("#coeff4").change(function() {
            updatemesh();
        });
        $("#default").click(function() {
            resetCoeffs();
            updatemesh();
        });
    });

    function downloadMsgPack(url, callback) {
        var oReq = new XMLHttpRequest();
        oReq.open("GET", url, true);
        oReq.responseType = "arraybuffer";

        oReq.onload = function (oEvent) {
            var arrayBuffer = oReq.response; // Note: not oReq.responseText
            if (arrayBuffer) {
                var byteArray = new Uint8Array(arrayBuffer);
                var data = msgpack.decode(byteArray);
                callback(data);
            }
        };
        oReq.send();
    }

    function modelReady(data) {
        model = data;
        origverts = quickMeshFromFeatures(model, indexs, face_features).valueOf();

        origverts2 = meshFromFeatures(model, face_features).valueOf();
        createMesh(origverts2, model.faces, model.UVs);

        console.log("model downloaded");
        initializeImgWarper();
    }

    function initializeImgWarper() {
        if(model && img.complete) {
            origpoints = [];
            origpoints.push(new ImgWarper.Point(0,0));
            origpoints.push(new ImgWarper.Point(0,img.height));
            origpoints.push(new ImgWarper.Point(img.width,img.height));
            origpoints.push(new ImgWarper.Point(img.width,0));
            for (i in origverts) {
                var vert = origverts[i];
                var vert4 = [vert[0], vert[1], vert[2], 1];
                var vert2d = project(vert4, modelview, projection, viewport).valueOf();
                origpoints.push(new ImgWarper.Point(vert2d[0],vert2d[1]));
            }

            console.log("initialize warper");
            imgWarper = new ImgWarper.Warper(canvas, img);
        }
    }

    function project(vert, modelview, projection, viewport) {
        var tmp = math.multiply(modelview, vert);
        tmp = math.multiply(projection,tmp);

        tmp = math.divide(tmp,tmp.valueOf()[3]);
        tmp = math.add(math.multiply(tmp,0.5),0.5);
        tmp = tmp.valueOf();
        tmp[0] = tmp[0] * viewport[2] + viewport[0];
        tmp[1] = tmp[1] * viewport[3] + viewport[1];

        return math.matrix([tmp[0],tmp[1]]);
    }

    function meshFromFeatures(model, features) {
        alpha = math.matrix(features);
        var shape = math.multiply(model.shapePC, alpha);
        shape = math.add(model.shapeMU, shape);
        var numVert = parseInt(shape._size[0]/3);
        var verts = shape.reshape([numVert,3]);

        return verts;
    }

    function quickMeshFromFeatures(model, indexs, features) {
        alpha = math.matrix(features);

        var quickPC = [];
        var quickMU = [];
        for (var i in indexs) {
            var index = indexs[i]*3;
            quickPC.push(model.shapePC[index]);
            quickPC.push(model.shapePC[index+1]);
            quickPC.push(model.shapePC[index+2]);

            quickMU.push(model.shapeMU[index]);
            quickMU.push(model.shapeMU[index+1]);
            quickMU.push(model.shapeMU[index+2]);
        }
        var shape = math.multiply(quickPC, alpha);
        shape = math.add(quickMU, shape);
        var numVert = parseInt(shape._size[0]/3);
        var verts = shape.reshape([numVert,3]);

        return verts;
    }

    function drawLandmarks(landmarks, color) {
        for (i in landmarks) {
            var vert = landmarks[i];
            var vert4 = [vert[0], vert[1], vert[2], 1];
            var vert2d = project(vert4, modelview, projection, viewport).valueOf();

            var radius = 10;
            ctx.beginPath();
            ctx.arc(vert2d[0], vert2d[1], radius, 0, 2 * Math.PI, false);
            ctx.fillStyle = color;
            ctx.fill();
            ctx.lineWidth = 5;
            ctx.strokeStyle = '#003300';
            ctx.stroke();

        }
    }

    function updatemesh() {
        //recalculate mesh
        var new_face_features = math.matrix(face_features.slice());
        var new_gender_features = math.multiply(gender_features, $("#coeffGender").val()*2);
        var new_age_features = math.multiply(age_features, $("#coeffAge").val()*50);
        var new_weight_features = math.multiply(weight_features, $("#coeffWeight").val()*40);
        var new_height_features = math.multiply(height_features, $("#coeffHeight").val()*40);

        new_face_features = math.add(new_face_features, new_gender_features);
        new_face_features = math.add(new_face_features, new_age_features);
        new_face_features = math.add(new_face_features, new_weight_features);
        new_face_features = math.add(new_face_features, new_height_features);

//        new_face_features[1] = parseFloat($("#coeff1").val());
//        new_face_features[2] = parseFloat($("#coeff2").val());
//        new_face_features[3] = parseFloat($("#coeff3").val());
//        new_face_features[4] = parseFloat($("#coeff4").val());

        var verts = quickMeshFromFeatures(model, indexs, new_face_features.valueOf()).valueOf();
//        var verts = meshFromFeatures(model, [parseFloat($("#coeff0").val()), parseFloat($("#coeff1").val())]);

        var newverts2 = meshFromFeatures(model, new_face_features.valueOf()).valueOf();
        updateMesh(newverts2);

        //warp image
        points = [];
        points.push(new ImgWarper.Point(0,0));
        points.push(new ImgWarper.Point(0,1619));
        points.push(new ImgWarper.Point(1214,1619));
        points.push(new ImgWarper.Point(1214,0));
        for (i in verts) {
            var vert = verts[i];
            var vert4 = [vert[0], vert[1], vert[2], 1];
            var vert2d = project(vert4, modelview, projection, viewport).valueOf();
            points.push(new ImgWarper.Point(vert2d[0],vert2d[1]));
        }
        imgWarper.warp(origpoints, points);
        if (showLandmarks) {
            drawLandmarks(origverts, "green");
            drawLandmarks(verts, "red");
        }
    }

    function resetCoeffs() {
        $("#coeffGender").val(0);
        $("#coeffAge").val(0);
        $("#coeffWeight").val(0);
        $("#coeffHeight").val(0);
    }

</script>
<body>
<div class="container">
    <div class="row">
        <div class="col-md-8">
            <canvas id="warpCanvas" class="img-responsive"></canvas>
        </div>
        <div class="col-md-4">
            <div class="form-group form-group-lg">
                <label class="control-label" for="coeffGender">Gender:</label>
                <input type="range" id="coeffGender" value="0" min="-5" max="5" step="0.1">
            </div>

            <div class="form-group form-group-lg">
                <label class="control-label" for="coeffAge">Age:</label>
                <input type="range" id="coeffAge" value="0" min="-5" max="5" step="0.1">
            </div>

            <div class="form-group form-group-lg">
                <label class="control-label" for="coeffWeight">Weight:</label>
                <input type="range" id="coeffWeight" value="0" min="-5" max="5" step="0.1">
            </div>

            <div class="form-group form-group-lg">
                <label class="control-label" for="coeffHeight">Height:</label>
                <input type="range" id="coeffHeight" value="0" min="-5" max="5" step="0.1">
            </div>

            <button id="default">Reset To Default</button>
            <div class="form-group form-group-lg">
                <label class="control-label" for="showlandmarks">Show Landmarks:</label>
                <input type="checkbox" id="showlandmarks">
            </div>
            <div class="form-group form-group-lg">
                <label class="control-label" for="showgrid">Show Grid:</label>
                <input type="checkbox" id="showgrid">
            </div>
            <div id="3dcanvas" style="width:500px; height:500px"></div>
        </div>
    </div>
</div>

</body>
</html>