<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Viewer</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/bootstrap-theme.min.css">

    <script src="js/math.min.js" type="text/javascript"></script>
    <script src="js/jquery-1.11.1.min.js" type="text/javascript"></script>
    <script src="js/msgpack.min.js"></script>
    <script src="js/bootstrap.min.js"></script>

    <script src="js/imagewarp/deformation.js"></script>
    <script src="js/imagewarp/interpolation.js"></script>
    <script src="js/imagewarp/point.js"></script>
    <script src="js/imagewarp/matrix22.js"></script>
</head>
<script>
    var modelview = math.matrix([[0.9676268696784973, 0.05260476842522621, 0.24684196710586548, 202.01211547851562], [0.02135360613465309, 0.9574664235115051, -0.2877534329891205, 308.64483642578125], [-0.2514801025390625, 0.2837089002132416, 0.9253469705581665, 0.0], [0.0, 0.0, 0.0, 1.0]]);

    var projection = math.matrix([[0.00582777988165617, 0.0, 0.0, -1.0], [0.0, 0.004369935020804405, 0.0, -1.0], [0.0, 0.0, -1.0, 0.0], [0.0, 0.0, 0.0, 1.0]]);

    var viewport = [0, 1619, 1214, -1619];

    var face_features = [-0.5532902693274548, -0.8292028651409497, 1.0571687459841956, -2.3025305505203026, 0.7430163410793367, -0.11145151560924439, 1.7776416134608717, 1.460948256842372, 1.7136922760503297, -2.6220371383058376, -2.941108959078685, -2.1813370277754833];

    var indexs = [11, 2578, 2579, 2580, 21, 2581, 2072, 2076, 2589, 2082, 2083, 2086, 2091, 2101, 590, 605, 606, 607, 2657, 2658, 610, 100, 614, 2160, 2161, 624, 114, 658, 662, 666, 2203, 2204, 157, 172, 173, 174, 177, 693, 181, 2235, 2237, 191, 2247, 1736, 1738, 2262, 2263, 2264, 2265, 1755, 1757, 736, 225, 229, 1766, 1767, 233, 2794, 2797, 756, 2816, 770, 775, 264, 270, 272, 2842, 1819, 1820, 797, 1822, 1823, 800, 1833, 812, 825, 1850, 1851, 315, 1861, 2373, 2374, 1863, 329, 841, 2394, 2395, 2396, 1895, 363, 365, 1908, 1909, 373, 379, 382, 392, 393, 398, 411, 413, 431, 2508, 2001, 2011, 2012, 2533, 2026];

    var canvas, ctx;
    var origverts, origpoints;
    var model;
    var imgWarper;
    var img = new Image();

    var showLandmarks = false;

    img.onload = function(){
        console.log("img downloaded");
        initializeImgWarper();
    };
    img.src="img/5i7r2x0.jpg";

    //init function
    $(function() {
        //begin downloading the bfm model
        downloadMsgPack('sfm.msg', modelReady);

        //get the canvas object
        canvas = document.getElementById("warpCanvas");
        origImage = document.getElementById("origImage");
        ctx = canvas.getContext("2d");

        $("#showlandmarks").change(function() {
            showLandmarks = !showLandmarks;
            updatemesh();
        });
        $("#showgrid").change(function() {
            imgWarper.toggleGrid();
            updatemesh();
        });

        $("#coeff0").change(function() {
            updatemesh();
        });
        $("#coeff1").change(function() {
            updatemesh();
        });
    });

    function downloadMsgPack(url, callback) {
        var oReq = new XMLHttpRequest();
        oReq.open("GET", url, true);
        oReq.responseType = "arraybuffer";

        oReq.onload = function (oEvent) {
            var arrayBuffer = oReq.response; // Note: not oReq.responseText
            if (arrayBuffer) {
                var byteArray = new Uint8Array(arrayBuffer);
                var data = msgpack.decode(byteArray);
                callback(data);
            }
        };
        oReq.send();
    }

    function modelReady(data) {
        model = data;
        origverts = quickMeshFromFeatures(model, indexs, face_features);
//        origverts = meshFromFeatures(bfm, face_features);

        origverts = origverts.valueOf();

        console.log("model downloaded");
        initializeImgWarper();
    }

    function initializeImgWarper() {
        if(model && img.complete) {
            origpoints = [];
            origpoints.push(new ImgWarper.Point(0,0));
            origpoints.push(new ImgWarper.Point(0,img.height));
            origpoints.push(new ImgWarper.Point(img.width,img.height));
            origpoints.push(new ImgWarper.Point(img.width,0));
            for (i in origverts) {
                var vert = origverts[i];
                var vert4 = [vert[0], vert[1], vert[2], 1];
                var vert2d = project(vert4, modelview, projection, viewport).valueOf();
                origpoints.push(new ImgWarper.Point(vert2d[0],vert2d[1]));
            }

            console.log("initialize warper");
            imgWarper = new ImgWarper.Warper(canvas, img);
        }
    }

    function project(vert, modelview, projection, viewport) {
        var tmp = math.multiply(modelview, vert);
        tmp = math.multiply(projection,tmp);

        tmp = math.divide(tmp,tmp.valueOf()[3]);
        tmp = math.add(math.multiply(tmp,0.5),0.5);
        tmp = tmp.valueOf();
        tmp[0] = tmp[0] * viewport[2] + viewport[0];
        tmp[1] = tmp[1] * viewport[3] + viewport[1];

        return math.matrix([tmp[0],tmp[1]]);
    }

    function meshFromFeatures(model, features) {
        var alpha = [];
        for(var i=0; i<model.shapeEV.length; i++) {
            var feature = 0;
            if(i in features) {
                feature = features[i]
            }
            alpha[i] = feature;//model.shapeEV[i] * feature;
        }
        alpha = math.matrix(alpha);
        var shape = math.multiply(model.shapePC, alpha);
        shape = math.add(model.shapeMU, shape);
        var numVert = parseInt(shape._size[0]/3);
        var verts = shape.reshape([numVert,3]);

        return verts;
    }

    function quickMeshFromFeatures(model, indexs, features) {
        var alpha = [];
        for(var i=0; i<model.shapeEV.length; i++) {
            var feature = 0;
            if(i in features) {
                feature = features[i]
            }
            alpha[i] = feature;//model.shapeEV[i] * feature;
        }
        alpha = math.matrix(alpha);

        var quickPC = [];
        var quickMU = [];
        for (var i in indexs) {
            var index = indexs[i]*3;
            quickPC.push(model.shapePC[index]);
            quickPC.push(model.shapePC[index+1]);
            quickPC.push(model.shapePC[index+2]);

            quickMU.push(model.shapeMU[index]);
            quickMU.push(model.shapeMU[index+1]);
            quickMU.push(model.shapeMU[index+2]);
        }
        var shape = math.multiply(quickPC, alpha);
        shape = math.add(quickMU, shape);
        var numVert = parseInt(shape._size[0]/3);
        var verts = shape.reshape([numVert,3]);

        return verts;
    }

    function drawLandmarks(landmarks) {
        for (i in landmarks) {
            var vert = landmarks[i];
            var vert4 = [vert[0], vert[1], vert[2], 1];
            var vert2d = project(vert4, modelview, projection, viewport).valueOf();

            var radius = 10;
            ctx.beginPath();
            ctx.arc(vert2d[0], vert2d[1], radius, 0, 2 * Math.PI, false);
            ctx.fillStyle = 'green';
            ctx.fill();
            ctx.lineWidth = 5;
            ctx.strokeStyle = '#003300';
            ctx.stroke();

        }
    }

    function updatemesh() {
        //recalculate mesh
        var verts = quickMeshFromFeatures(model, indexs, [face_features[0] + parseFloat($("#coeff0").val()), face_features[1] + parseFloat($("#coeff1").val())]);
//        var verts = meshFromFeatures(bfm, [parseFloat($("#coeff0").val()), parseFloat($("#coeff1").val())]);
        verts = verts.valueOf();
        //draw landmarks
        points = [];
        points.push(new ImgWarper.Point(0,0));
        points.push(new ImgWarper.Point(0,1619));
        points.push(new ImgWarper.Point(1214,1619));
        points.push(new ImgWarper.Point(1214,0));
        for (i in verts) {
            var vert = verts[i];
            var vert4 = [vert[0], vert[1], vert[2], 1];
            var vert2d = project(vert4, modelview, projection, viewport).valueOf();
            points.push(new ImgWarper.Point(vert2d[0],vert2d[1]));
        }
        imgWarper.warp(origpoints, points);
        if (showLandmarks) {
            drawLandmarks(verts);
        }
    }

</script>
<body>
<div class="container">
    <div class="row">
        <div class="col-md-8">
            <canvas id="warpCanvas" class="img-responsive"></canvas>
        </div>
        <div class="col-md-4">
            <div class="form-group form-group-lg">
                <label class="control-label" for="coeff0">Coefficient 0:</label>
                <input type="range" id="coeff0" value="0" min="-4" max="4" step="0.1">
            </div>

            <div class="form-group form-group-lg">
                <label class="control-label" for="coeff1">Coefficient 1:</label>
                <input type="range" id="coeff1" value="0" min="-4" max="4" step="0.1">
            </div>

            <div class="form-group form-group-lg">
                <label class="control-label" for="showlandmarks">Show Landmarks:</label>
                <input type="checkbox" id="showlandmarks">
            </div>
            <div class="form-group form-group-lg">
                <label class="control-label" for="showgrid">Show Grid:</label>
                <input type="checkbox" id="showgrid">
            </div>
        </div>
    </div>
</div>

</body>
</html>